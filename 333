import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import pandas as pd
import yfinance as yf
import datetime

# ä½ çš„ Gmail è¨­å®š
GMAIL_USER = "zxc990503@gmail.com"
GMAIL_APP_PASSWORD = "tvst cwan yyhl nfaa"

# å¤šå€‹æ”¶ä»¶äººï¼Œç”¨è‹±æ–‡é€—è™Ÿéš”é–‹
RECEIVER_EMAILS = "zxc990503@gmail.com,chiaoi_peng@megasec.com.tw"

def send_email(subject, body):
    msg = MIMEMultipart()
    msg["From"] = GMAIL_USER
    receivers = [email.strip() for email in RECEIVER_EMAILS.split(",")]
    msg["To"] = ", ".join(receivers)
    msg["Subject"] = subject

    msg.attach(MIMEText(body, "plain", "utf-8"))

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.sendmail(GMAIL_USER, receivers, msg.as_string())

def calculate_macd(df):
    df['EMA12'] = df['Close'].ewm(span=12).mean()
    df['EMA26'] = df['Close'].ewm(span=26).mean()
    df['DIF'] = df['EMA12'] - df['EMA26']
    df['MACD'] = df['DIF'].ewm(span=9).mean()
    return df

def is_golden_cross(yesterday, today_data):
    dif_y = yesterday['DIF']
    macd_y = yesterday['MACD']
    dif_t = today_data['DIF']
    macd_t = today_data['MACD']
    if hasattr(dif_y, "values"):
        dif_y = dif_y.values[0]
    if hasattr(macd_y, "values"):
        macd_y = macd_y.values[0]
    if hasattr(dif_t, "values"):
        dif_t = dif_t.values[0]
    if hasattr(macd_t, "values"):
        macd_t = macd_t.values[0]
    return (dif_y < macd_y) and (dif_t > macd_t)

def main():
    twse_symbols = ['0050', '2330', '2317', '2303', '2412']
    today = datetime.date.today().isoformat()
    golden_crosses = []

    for symbol in twse_symbols:
        full_symbol = symbol + '.TW'
        try:
            df = yf.download(full_symbol, period='10d', interval='1d', progress=False, auto_adjust=True)
            if len(df) < 2:
                continue

            df = calculate_macd(df)

            yesterday = df.iloc[-2]
            today_data = df.iloc[-1]

            if is_golden_cross(yesterday, today_data):
                diff_percent = (today_data['DIF'] - today_data['MACD']) / abs(today_data['MACD']) * 100 if today_data['MACD'] != 0 else 0
                golden_crosses.append(f"{symbol} æ”¶ç›¤åƒ¹: {today_data['Close']:.2f} å·®è·%: {diff_percent:.2f}")

        except Exception as e:
            print(f"éŒ¯èª¤ï¼š{symbol} - {e}")

    if golden_crosses:
        body = "ðŸ“ˆ ä»Šæ—¥MACDé»ƒé‡‘äº¤å‰è‚¡ç¥¨ï¼š\n" + "\n".join(golden_crosses)
    else:
        body = "âŒ ä»Šæ—¥æ²’æœ‰MACDé»ƒé‡‘äº¤å‰çš„è‚¡ç¥¨"

    send_email(f"MACD é»ƒé‡‘äº¤å‰é€šçŸ¥ - {today}", body)
    print("é€šçŸ¥å·²å¯„å‡º!")

if __name__ == "__main__":
    main()
